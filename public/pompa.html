<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kontrol Pompa - Ruang Kebon</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #2ecc71;
        }
        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .control-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 30px;
            border-left: 5px solid #2ecc71;
        }
        .pompa-status {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .pompa-on {
            background: #d4edda;
            color: #155724;
            border: 3px solid #28a745;
        }
        .pompa-off {
            background: #f8d7da;
            color: #721c24;
            border: 3px solid #dc3545;
        }
        .control-buttons {
            margin: 30px 0;
        }
        .btn {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-on {
            background: #28a745;
            color: white;
        }
        .btn-on:hover {
            background: #218838;
            transform: scale(1.05);
        }
        .btn-off {
            background: #dc3545;
            color: white;
        }
        .btn-off:hover {
            background: #c82333;
            transform: scale(1.05);
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .status-card {
            width: 100%;
            text-align: left;
            margin-bottom: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        #status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }
        .online {
            background: #d4edda;
            color: #155724;
        }
        .offline {
            background: #f8d7da;
            color: #721c24;
        }
        .data-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f1f1f1;
        }
        .auto-control {
            margin: 20px 0;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 10px;
        }
        .blink {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .device-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .sync-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-left: 10px;
        }
        .sync-ok {
            background: #d4edda;
            color: #155724;
        }
        .sync-warning {
            background: #fff3cd;
            color: #856404;
        }
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connection-online {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        .connection-offline {
            background: #dc3545;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .history-empty {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }
        
        /* CSS untuk Multiple Schedules */
        .schedules-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .schedule-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-top: 4px solid #2ecc71;
        }
        
        .schedule-card.schedule-1 {
            border-top-color: #3498db;
        }
        
        .schedule-card.schedule-2 {
            border-top-color: #e74c3c;
        }
        
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .schedule-title {
            font-weight: bold;
            font-size: 1.1em;
            color: #2c3e50;
        }
        
        .schedule-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #2ecc71;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .time-input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 15px 0;
        }
        
        .time-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-input label {
            min-width: 70px;
            font-weight: bold;
        }
        
        .time-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .time-controls input {
            width: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 1em;
        }
        
        .time-controls input:focus {
            outline: none;
            border-color: #2ecc71;
            box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.2);
        }
        
        .schedule-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .btn-save {
            background: #2ecc71 !important;
            color: white !important;
        }
        
        .btn-save:hover {
            background: #27ae60 !important;
        }
        
        .btn-reset {
            background: #ffc107 !important;
            color: #212529 !important;
        }
        
        .btn-reset:hover {
            background: #e0a800 !important;
        }
        
        .btn-delete {
            background: #dc3545 !important;
            color: white !important;
        }
        
        .btn-delete:hover {
            background: #c82333 !important;
        }
        
        .current-schedule {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .schedule-item:last-child {
            border-bottom: none;
        }
        
        .schedule-active {
            color: #28a745 !important;
            animation: blink 1s infinite;
        }
        
        .schedule-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.85em;
            color: #666;
        }
        
        .quick-schedule {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .quick-schedule-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .quick-schedule-btn {
            padding: 8px 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .quick-schedule-btn:hover {
            background: #5a6268;
        }
        
        .schedule-test-controls {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .multiple-schedules-info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">‚Üê Kembali ke Dashboard</a>

        <div class="header">
            <h1>üîå Kontrol Pompa Air - Ruang Kebon</h1>
            <p>Sistem Kontrol Otomatis dan Manual Pengairan Kebun</p>
        </div>

        <div class="status-card">
            <h3>Status Sistem Pompa</h3>
            <div id="status" class="offline">
                <span class="connection-status connection-offline"></span>
                üî¥ OFFLINE - Menunggu koneksi perangkat pompa...
            </div>
            <div id="deviceInfo">Device ID: --</div>
            <div id="lastSeen">Last seen: --</div>
            <div id="connectionTime">Connection time: --</div>
            <div id="syncStatus" class="sync-status sync-warning" style="display: none">
                ‚ö†Ô∏è Menunggu sinkronisasi status...
            </div>
            <div id="deviceWarning" class="device-warning" style="display: none">
                ‚ö†Ô∏è Device pompa khusus belum terdeteksi. Pastikan ESP32 pompa terhubung.
            </div>
        </div>

        <div class="control-panel">
            <h2>Status Pompa Saat Ini</h2>
            <div id="pompa-status" class="pompa-off">üî¥ POMPA MATI</div>

            <div id="pompa-info">
                <p>Mode: <span id="pompa-mode">--</span></p>
                <p>Status Aktual: <span id="actual-status">--</span></p>
                <p>Terakhir diupdate: <span id="last-updated">--</span></p>
            </div>

            <div class="control-buttons">
                <button class="btn btn-on" onclick="controlPompa('on')" id="btn-on" disabled>
                    üöÄ NYALAKAN POMPA
                </button>
                <button class="btn btn-off" onclick="controlPompa('off')" id="btn-off" disabled>
                    ‚èπÔ∏è MATIKAN POMPA
                </button>
            </div>

            <div class="auto-control">
                <h3>‚è∞ Kontrol Otomatis (Multiple Schedules)</h3>
                
                <div class="multiple-schedules-info">
                    <strong>‚ú® Fitur Baru:</strong> Sekarang Anda bisa mengatur 2 jadwal penyiraman dalam sehari (pagi & sore)!
                    Waktu input bebas, tidak harus sesuai waktu saat ini.
                </div>
                
                <div class="schedules-container">
                    <!-- Schedule 1 -->
                    <div class="schedule-card schedule-1">
                        <div class="schedule-header">
                            <div class="schedule-title">üåÖ Jadwal Pagi</div>
                            <div class="schedule-toggle">
                                <span>Aktifkan</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="schedule1-enabled" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="time-input-group">
                            <div class="time-input">
                                <label for="start-hour-1">Mulai:</label>
                                <div class="time-controls">
                                    <input type="number" id="start-hour-1" min="0" max="23" value="6" placeholder="Jam">
                                    <span>:</span>
                                    <input type="number" id="start-minute-1" min="0" max="59" value="0" placeholder="Menit">
                                    <span>:</span>
                                    <input type="number" id="start-second-1" min="0" max="59" value="0" placeholder="Detik">
                                </div>
                            </div>
                            
                            <div class="time-input">
                                <label for="end-hour-1">Selesai:</label>
                                <div class="time-controls">
                                    <input type="number" id="end-hour-1" min="0" max="23" value="6" placeholder="Jam">
                                    <span>:</span>
                                    <input type="number" id="end-minute-1" min="0" max="59" value="15" placeholder="Menit">
                                    <span>:</span>
                                    <input type="number" id="end-second-1" min="0" max="59" value="0" placeholder="Detik">
                                </div>
                            </div>
                        </div>
                        
                        <div class="schedule-actions">
                            <button class="btn btn-save" onclick="saveSchedule(1)">
                                üíæ Simpan Jadwal 1
                            </button>
                            <button class="btn" onclick="testSchedule(1)">
                                üß™ Test Jadwal 1
                            </button>
                        </div>
                    </div>
                    
                    <!-- Schedule 2 -->
                    <div class="schedule-card schedule-2">
                        <div class="schedule-header">
                            <div class="schedule-title">üåá Jadwal Sore</div>
                            <div class="schedule-toggle">
                                <span>Aktifkan</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="schedule2-enabled" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="time-input-group">
                            <div class="time-input">
                                <label for="start-hour-2">Mulai:</label>
                                <div class="time-controls">
                                    <input type="number" id="start-hour-2" min="0" max="23" value="17" placeholder="Jam">
                                    <span>:</span>
                                    <input type="number" id="start-minute-2" min="0" max="59" value="0" placeholder="Menit">
                                    <span>:</span>
                                    <input type="number" id="start-second-2" min="0" max="59" value="0" placeholder="Detik">
                                </div>
                            </div>
                            
                            <div class="time-input">
                                <label for="end-hour-2">Selesai:</label>
                                <div class="time-controls">
                                    <input type="number" id="end-hour-2" min="0" max="23" value="17" placeholder="Jam">
                                    <span>:</span>
                                    <input type="number" id="end-minute-2" min="0" max="59" value="15" placeholder="Menit">
                                    <span>:</span>
                                    <input type="number" id="end-second-2" min="0" max="59" value="0" placeholder="Detik">
                                </div>
                            </div>
                        </div>
                        
                        <div class="schedule-actions">
                            <button class="btn btn-save" onclick="saveSchedule(2)">
                                üíæ Simpan Jadwal 2
                            </button>
                            <button class="btn" onclick="testSchedule(2)">
                                üß™ Test Jadwal 2
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="schedule-actions" style="justify-content: center; margin-top: 20px;">
                    <button class="btn btn-save" onclick="saveAllSchedules()">
                        üíæ Simpan Semua Jadwal
                    </button>
                    <button class="btn btn-reset" onclick="resetAllSchedules()">
                        üîÑ Reset Semua Jadwal
                    </button>
                    <button class="btn btn-delete" onclick="deleteAllSchedules()" id="btn-delete-all" disabled>
                        üóëÔ∏è Hapus Semua Jadwal
                    </button>
                </div>
                
                <div class="quick-schedule">
                    <h5>‚è±Ô∏è Jadwal Cepat (Testing):</h5>
                    <p><small>Set jadwal untuk testing waktu tertentu:</small></p>
                    <div class="quick-schedule-buttons">
                        <button class="quick-schedule-btn" onclick="setQuickSchedule(5)">5 menit dari sekarang</button>
                        <button class="quick-schedule-btn" onclick="setQuickSchedule(10)">10 menit dari sekarang</button>
                        <button class="quick-schedule-btn" onclick="setQuickSchedule(30)">30 menit dari sekarang</button>
                        <button class="quick-schedule-btn" onclick="setTestScheduleNow()">Mulai Sekarang (5 menit)</button>
                    </div>
                </div>
                
                <div class="schedule-test-controls">
                    <h5>üß™ Test Manual Trigger:</h5>
                    <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: center;">
                        <button class="quick-schedule-btn" onclick="triggerScheduleNow()" style="background: #28a745;">
                            üöÄ Trigger Sekarang (5 menit)
                        </button>
                        <button class="quick-schedule-btn" onclick="stopScheduleNow()" style="background: #dc3545;">
                            ‚èπÔ∏è Stop Sekarang
                        </button>
                    </div>
                </div>
                
                <div class="current-schedule">
                    <h4>üìã Jadwal Aktif di Server</h4>
                    <div id="active-schedules-container">
                        <p style="text-align: center; color: #666;">Memuat jadwal...</p>
                    </div>
                    <div class="schedule-item">
                        <span>Waktu Server:</span>
                        <span id="server-time">--:--:--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="data-table">
            <h3>Riwayat Kontrol Pompa</h3>
            <table>
                <thead>
                    <tr>
                        <th>Waktu</th>
                        <th>Status</th>
                        <th>Mode</th>
                        <th>Dikontrol Oleh</th>
                        <th>Sumber</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
            <h4>‚ö†Ô∏è Perhatian:</h4>
            <p>‚Ä¢ Dashboard akan selalu menampilkan status AKTUAL dari ESP32 pompa</p>
            <p>‚Ä¢ Status ONLINE hanya jika ESP32 pompa aktif mengirim data dalam 10 detik terakhir</p>
            <p>‚Ä¢ Kontrol manual hanya bekerja ketika status ONLINE</p>
            <p>‚Ä¢ Jadwal otomatis disimpan di SERVER (tidak di ESP32)</p>
            <p>‚Ä¢ ESP32 harus polling server untuk mendapatkan perintah jadwal</p>
            <p>‚Ä¢ Sekarang bisa atur 2 jadwal (pagi & sore) dengan waktu bebas</p>
        </div>
    </div>

    <script>
        let refreshInterval;
        let isAutoMode = false;
        let currentPompaStatus = false;
        let isPompaDeviceOnline = false;
        let lastPompaData = null;
        let isSynced = false;
        let lastSuccessfulUpdate = 0;
        const OFFLINE_THRESHOLD = 15000;
        let historyLog = [];
        const MAX_HISTORY_ITEMS = 20;
        let deviceId = "POMPA_DEVICE";
        let currentSchedules = [];
        let scheduleCheckInterval = null;

        // ==================== FUNGSI UTAMA ====================
        function loadData() {
            fetch("/api/status/all")
                .then((response) => response.json())
                .then((data) => {
                    console.log("üìä All Status Data:", data);
                    processPompaData(data);
                    checkConnectionTimeout();
                })
                .catch((error) => {
                    console.error("Error fetching status:", error);
                    setOfflineStatus();
                });
        }

        function checkConnectionTimeout() {
            const now = Date.now();
            if (lastSuccessfulUpdate > 0 && now - lastSuccessfulUpdate > OFFLINE_THRESHOLD) {
                console.log("üïí Connection timeout detected");
                setOfflineStatus();
            }
        }

        function processPompaData(data) {
            const pompaSensor = data.sensors.pompa;
            console.log("üîß Pompa Sensor Data:", pompaSensor);

            const isDataFresh = isPompaDataFresh(pompaSensor);

            if (isDataFresh && pompaSensor.data && Object.keys(pompaSensor.data).length > 0) {
                isPompaDeviceOnline = true;
                lastSuccessfulUpdate = Date.now();

                updateDeviceStatus({
                    isOnline: true,
                    lastSeen: pompaSensor.lastUpdate,
                    deviceId: pompaSensor.data.deviceId || "POMPA_DEVICE",
                });

                lastPompaData = pompaSensor.data;
                updateDisplayFromESP32(pompaSensor.data);
                checkSyncStatus(pompaSensor.data);
                addToHistoryFromData(pompaSensor.data, "system");
                
            } else {
                isPompaDeviceOnline = false;
                setOfflineStatus();
            }

            loadHistory();
            loadSchedulesFromServer();
            
            if (lastPompaData && lastPompaData.deviceId) {
                deviceId = lastPompaData.deviceId;
            }
        }

        function isPompaDataFresh(pompaSensor) {
            if (!pompaSensor || !pompaSensor.lastUpdate) return false;
            const lastUpdate = new Date(pompaSensor.lastUpdate).getTime();
            const now = Date.now();
            const dataAge = now - lastUpdate;
            console.log("üïí Data age: " + dataAge + "ms");
            return dataAge < 10000;
        }

        function updateDeviceStatus(status) {
            const statusElement = document.getElementById("status");
            const lastSeenElement = document.getElementById("lastSeen");
            const deviceInfoElement = document.getElementById("deviceInfo");
            const warningElement = document.getElementById("deviceWarning");
            const connectionTimeElement = document.getElementById("connectionTime");
            const connectionIndicator = statusElement.querySelector(".connection-status");

            if (status.isOnline && isPompaDeviceOnline) {
                statusElement.className = "online";
                connectionIndicator.className = "connection-status connection-online";
                statusElement.innerHTML = '<span class="connection-status connection-online"></span>‚úÖ ONLINE - Terhubung ke Kontroler Pompa';

                if (status.lastSeen) {
                    const lastSeen = new Date(status.lastSeen);
                    const now = new Date();
                    const diffSeconds = Math.round((now - lastSeen) / 1000);
                    lastSeenElement.textContent = "Last seen: " + lastSeen.toLocaleString() + " (" + diffSeconds + " detik lalu)";
                    const connectionDuration = Math.round((now - lastSeen) / 1000);
                    connectionTimeElement.textContent = "Connection time: " + connectionDuration + " detik";
                }

                if (status.deviceId) {
                    deviceInfoElement.textContent = "Device ID: " + status.deviceId;
                }

                warningElement.style.display = "none";
                document.getElementById("btn-on").disabled = false;
                document.getElementById("btn-off").disabled = false;
            } else {
                setOfflineStatus();
            }
        }

        function setOfflineStatus() {
            const statusElement = document.getElementById("status");
            const deviceInfoElement = document.getElementById("deviceInfo");
            const lastSeenElement = document.getElementById("lastSeen");
            const warningElement = document.getElementById("deviceWarning");
            const connectionTimeElement = document.getElementById("connectionTime");
            const syncElement = document.getElementById("syncStatus");

            isPompaDeviceOnline = false;
            lastSuccessfulUpdate = 0;

            statusElement.className = "offline";
            const connectionIndicator = statusElement.querySelector(".connection-status") || document.createElement("span");
            connectionIndicator.className = "connection-status connection-offline";
            statusElement.innerHTML = '<span class="connection-status connection-offline"></span>üî¥ OFFLINE - Kontroler Pompa tidak terhubung';

            deviceInfoElement.textContent = "Device ID: --";
            lastSeenElement.textContent = "Last seen: --";
            connectionTimeElement.textContent = "Connection time: --";
            syncElement.style.display = "none";

            warningElement.style.display = "block";
            warningElement.innerHTML = "‚ö†Ô∏è Device pompa offline. Pastikan ESP32 pompa menyala dan terhubung WiFi";

            document.getElementById("btn-on").disabled = true;
            document.getElementById("btn-off").disabled = true;
            document.getElementById("pompa-status").className = "pompa-status pompa-off";
            document.getElementById("pompa-status").innerHTML = "üî¥ POMPA MATI";
            document.getElementById("pompa-mode").textContent = "--";
            document.getElementById("actual-status").textContent = "OFFLINE";
            document.getElementById("actual-status").style.color = "#dc3545";
            document.getElementById("last-updated").textContent = "--";
        }

        function updateDisplayFromESP32(data) {
            console.log("üîÑ Update Display from ESP32:", data);

            if (data.status !== undefined) {
                const pompaStatus = document.getElementById("pompa-status");
                const actualStatusElement = document.getElementById("actual-status");

                currentPompaStatus = data.status;

                if (data.status) {
                    pompaStatus.className = "pompa-status pompa-on";
                    pompaStatus.innerHTML = "üíß POMPA MENYALA";
                    actualStatusElement.textContent = "ON (Dari ESP32)";
                    actualStatusElement.style.color = "#28a745";
                } else {
                    pompaStatus.className = "pompa-status pompa-off";
                    pompaStatus.innerHTML = "üî¥ POMPA MATI";
                    actualStatusElement.textContent = "OFF (Dari ESP32)";
                    actualStatusElement.style.color = "#dc3545";
                }

                updateButtonStates();
                document.getElementById("pompa-mode").textContent = data.mode || "manual";
                document.getElementById("last-updated").textContent = new Date().toLocaleTimeString();
                isAutoMode = data.mode === "auto";
            }
        }

        function updateButtonStates() {
            const btnOn = document.getElementById("btn-on");
            const btnOff = document.getElementById("btn-off");

            if (currentPompaStatus) {
                btnOn.disabled = true;
                btnOff.disabled = false;
            } else {
                btnOn.disabled = false;
                btnOff.disabled = true;
            }
        }

        function checkSyncStatus(data) {
            const syncElement = document.getElementById("syncStatus");

            if (data && data.status !== undefined) {
                syncElement.style.display = "inline-block";
                syncElement.className = "sync-status sync-ok";
                syncElement.textContent = "‚úÖ Status tersinkronisasi";
                isSynced = true;
            } else {
                syncElement.style.display = "inline-block";
                syncElement.className = "sync-status sync-warning";
                syncElement.textContent = "‚ö†Ô∏è Menunggu data status...";
                isSynced = false;
            }
        }

        // ==================== FUNGSI KONTROL ====================
        function controlPompa(action) {
            if (!isPompaDeviceOnline) {
                showNotification("‚ùå Device pompa offline, tidak dapat mengontrol", "error");
                return;
            }

            const button = action === "on" ? document.getElementById("btn-on") : document.getElementById("btn-off");
            const originalText = button.innerHTML;

            button.innerHTML = "‚è≥ Mengirim perintah...";
            button.disabled = true;

            const pompaStatus = document.getElementById("pompa-status");
            const actualStatusElement = document.getElementById("actual-status");

            if (action === "on") {
                pompaStatus.className = "pompa-status pompa-on blink";
                pompaStatus.innerHTML = "‚è≥ MENYALAKAN...";
                actualStatusElement.textContent = "Menunggu konfirmasi ESP32...";
                actualStatusElement.style.color = "#ffc107";
            } else {
                pompaStatus.className = "pompa-status pompa-off blink";
                pompaStatus.innerHTML = "‚è≥ MEMATIKAN...";
                actualStatusElement.textContent = "Menunggu konfirmasi ESP32...";
                actualStatusElement.style.color = "#ffc107";
            }

            fetch("/api/pompa/control", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    action: action,
                    mode: "manual",
                    deviceId: deviceId
                }),
            })
            .then((response) => response.json())
            .then((data) => {
                button.innerHTML = originalText;
                console.log("‚úÖ Control response:", data);

                showNotification("Perintah " + (action === "on" ? "nyala" : "mati") + " dikirim ke ESP32", "success");

                addToHistoryFromData({
                    status: action === "on",
                    mode: "manual",
                    deviceId: deviceId
                }, "web-dashboard");
            })
            .catch((error) => {
                button.innerHTML = originalText;
                button.disabled = false;
                if (lastPompaData) updateDisplayFromESP32(lastPompaData);
                showNotification("Gagal mengirim perintah ke ESP32", "error");
                console.error("Error:", error);
            });
        }

        // ==================== FUNGSI SCHEDULE BARU ====================
        function saveSchedule(scheduleNumber) {
            const enabled = document.getElementById(`schedule${scheduleNumber}-enabled`).checked;
            const startHour = parseInt(document.getElementById(`start-hour-${scheduleNumber}`).value) || 0;
            const startMinute = parseInt(document.getElementById(`start-minute-${scheduleNumber}`).value) || 0;
            const startSecond = parseInt(document.getElementById(`start-second-${scheduleNumber}`).value) || 0;
            
            const endHour = parseInt(document.getElementById(`end-hour-${scheduleNumber}`).value) || 0;
            const endMinute = parseInt(document.getElementById(`end-minute-${scheduleNumber}`).value) || 0;
            const endSecond = parseInt(document.getElementById(`end-second-${scheduleNumber}`).value) || 0;

            const scheduleData = {
                scheduleId: scheduleNumber,
                enabled: enabled,
                start: { hour: startHour, minute: startMinute, second: startSecond },
                end: { hour: endHour, minute: endMinute, second: endSecond },
                name: scheduleNumber === 1 ? "Jadwal Pagi" : "Jadwal Sore"
            };

            const btn = document.querySelector(`.schedule-card.schedule-${scheduleNumber} .btn-save`);
            const originalText = btn.innerHTML;
            
            btn.innerHTML = "‚è≥ Menyimpan...";
            btn.disabled = true;

            // PERBAIKAN: Gunakan endpoint yang benar
            fetch("/api/pompa/schedules", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    deviceId: deviceId,
                    schedule: scheduleData,
                    action: "set_schedule"
                }),
            })
            .then(response => response.json())
            .then(data => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                if (data.success) {
                    showNotification(`‚úÖ Jadwal ${scheduleNumber} disimpan di server`, "success");
                    loadSchedulesFromServer();
                    
                    addToHistoryFromData({
                        status: currentPompaStatus,
                        mode: "auto",
                        deviceId: deviceId,
                        action: `set_schedule_${scheduleNumber}`,
                        schedule: scheduleData
                    }, "web-dashboard");
                    
                } else {
                    showNotification("‚ùå " + (data.message || "Gagal menyimpan"), "error");
                }
            })
            .catch(error => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                showNotification("‚ùå Gagal terhubung ke server", "error");
                console.error("Error:", error);
            });
        }

        function saveAllSchedules() {
            // Simpan schedule 1
            if (document.getElementById('schedule1-enabled').checked) {
                saveSchedule(1);
            }
            
            // Simpan schedule 2
            if (document.getElementById('schedule2-enabled').checked) {
                setTimeout(() => saveSchedule(2), 500);
            }
            
            showNotification("üíæ Menyimpan semua jadwal...", "info");
        }

        function resetAllSchedules() {
            if (confirm("Reset semua jadwal ke nilai default?")) {
                // Reset schedule 1 ke pagi
                document.getElementById('schedule1-enabled').checked = true;
                document.getElementById('start-hour-1').value = 6;
                document.getElementById('start-minute-1').value = 0;
                document.getElementById('start-second-1').value = 0;
                document.getElementById('end-hour-1').value = 6;
                document.getElementById('end-minute-1').value = 15;
                document.getElementById('end-second-1').value = 0;
                
                // Reset schedule 2 ke sore
                document.getElementById('schedule2-enabled').checked = true;
                document.getElementById('start-hour-2').value = 17;
                document.getElementById('start-minute-2').value = 0;
                document.getElementById('start-second-2').value = 0;
                document.getElementById('end-hour-2').value = 17;
                document.getElementById('end-minute-2').value = 15;
                document.getElementById('end-second-2').value = 0;
                
                showNotification("üîÑ Semua jadwal direset ke default", "info");
            }
        }

        function deleteAllSchedules() {
            if (!confirm("Hapus semua jadwal dari server?")) return;
            
            const btnDelete = document.getElementById('btn-delete-all');
            const originalText = btnDelete.innerHTML;
            
            btnDelete.innerHTML = "‚è≥ Menghapus...";
            btnDelete.disabled = true;
            
            // PERBAIKAN: Gunakan endpoint yang benar
            fetch(`/api/pompa/schedules/${deviceId}?action=delete_all`, {
                method: "DELETE"
            })
            .then(response => response.json())
            .then(data => {
                btnDelete.innerHTML = originalText;
                
                if (data.success) {
                    showNotification("üóëÔ∏è Semua jadwal dihapus dari server", "success");
                    currentSchedules = [];
                    updateActiveSchedulesDisplay();
                    document.getElementById('btn-delete-all').disabled = true;
                    
                    addToHistoryFromData({
                        status: currentPompaStatus,
                        mode: "manual",
                        deviceId: deviceId,
                        action: "delete_all_schedules"
                    }, "web-dashboard");
                    
                } else {
                    showNotification("‚ùå Gagal menghapus jadwal", "error");
                    btnDelete.disabled = false;
                }
            })
            .catch(error => {
                btnDelete.innerHTML = originalText;
                btnDelete.disabled = false;
                showNotification("‚ùå Gagal terhubung ke server", "error");
                console.error("Error:", error);
            });
        }

        function loadSchedulesFromServer() {
            // PERBAIKAN: Gunakan endpoint yang benar
            fetch(`/api/pompa/schedules/${deviceId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.hasSchedules && data.schedules && data.schedules.length > 0) {
                    currentSchedules = data.schedules;
                    updateActiveSchedulesDisplay();
                    
                    // Update form input berdasarkan data dari server
                    currentSchedules.forEach(schedule => {
                        if (schedule.scheduleId === 1 || schedule.scheduleId === 2) {
                            const id = schedule.scheduleId;
                            document.getElementById(`schedule${id}-enabled`).checked = schedule.isActive !== false;
                            if (schedule.start) {
                                document.getElementById(`start-hour-${id}`).value = schedule.start.hour;
                                document.getElementById(`start-minute-${id}`).value = schedule.start.minute;
                                document.getElementById(`start-second-${id}`).value = schedule.start.second;
                            }
                            if (schedule.end) {
                                document.getElementById(`end-hour-${id}`).value = schedule.end.hour;
                                document.getElementById(`end-minute-${id}`).value = schedule.end.minute;
                                document.getElementById(`end-second-${id}`).value = schedule.end.second;
                            }
                        }
                    });
                    
                    document.getElementById('btn-delete-all').disabled = false;
                    console.log("üìÖ Schedules loaded:", currentSchedules);
                    
                    // Update schedule status display
                    const statusContainer = document.getElementById('active-schedules-container');
                    let statusHtml = '';
                    
                    if (data.status === "running") {
                        statusHtml = '<p style="color: #28a745; font-weight: bold;">üíß Pompa sedang menyala (jadwal aktif)</p>';
                    } else if (data.status === "within_schedule") {
                        statusHtml = '<p style="color: #17a2b8;">‚è∞ Dalam waktu jadwal</p>';
                    } else if (data.status === "waiting") {
                        const nextRun = data.nextRunSeconds || 0;
                        const hours = Math.floor(nextRun / 3600);
                        const minutes = Math.floor((nextRun % 3600) / 60);
                        const seconds = nextRun % 60;
                        const timeStr = padZero(hours) + ':' + padZero(minutes) + ':' + padZero(seconds);
                        statusHtml = `<p style="color: #6c757d;">‚è≥ Jadwal berikutnya dalam ${timeStr}</p>`;
                    }
                    
                    if (statusHtml) {
                        statusContainer.innerHTML = statusHtml;
                    }
                    
                } else {
                    console.log("üìÖ No schedules found");
                    document.getElementById('active-schedules-container').innerHTML = 
                        '<p style="text-align: center; color: #666;">Tidak ada jadwal aktif</p>';
                    document.getElementById('btn-delete-all').disabled = true;
                }
            })
            .catch(error => {
                console.error("Error loading schedules:", error);
                document.getElementById('active-schedules-container').innerHTML = 
                    '<p style="text-align: center; color: #dc3545;">Gagal memuat jadwal dari server</p>';
            });
        }

        function updateActiveSchedulesDisplay() {
            const container = document.getElementById('active-schedules-container');
            
            if (!currentSchedules || currentSchedules.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Tidak ada jadwal aktif</p>';
                return;
            }
            
            let html = '';
            currentSchedules.forEach(schedule => {
                if (schedule.enabled !== false) {
                    const startTime = formatTime(schedule.start.hour, schedule.start.minute, schedule.start.second);
                    const endTime = formatTime(schedule.end.hour, schedule.end.minute, schedule.end.second);
                    const duration = calculateDuration(schedule.start, schedule.end);
                    const status = schedule.isRunning ? 
                        '<span style="color: #28a745; font-weight: bold;">üíß Sedang Menyiram</span>' : 
                        '<span style="color: #6c757d;">‚è∞ Terjadwal</span>';
                    
                    html += `
                        <div class="schedule-item">
                            <span>${schedule.name || `Jadwal ${schedule.scheduleId}`}:</span>
                            <span><strong>${startTime} - ${endTime}</strong> (${duration}) ${status}</span>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        // ==================== FUNGSI HELPER ====================
        function formatTime(hours, minutes, seconds) {
            const pad = num => num < 10 ? '0' + num : num;
            return pad(hours) + ':' + pad(minutes) + ':' + pad(seconds);
        }
        
        function padZero(num) {
            return num < 10 ? '0' + num : num;
        }

        function calculateDuration(start, end) {
            const startSec = start.hour * 3600 + start.minute * 60 + start.second;
            const endSec = end.hour * 3600 + end.minute * 60 + end.second;
            let durationSec = endSec - startSec;
            
            if (durationSec < 0) durationSec += 24 * 3600;
            
            const hours = Math.floor(durationSec / 3600);
            const minutes = Math.floor((durationSec % 3600) / 60);
            const seconds = durationSec % 60;
            
            let duration = "";
            if (hours > 0) duration += hours + " jam ";
            if (minutes > 0) duration += minutes + " menit ";
            if (seconds > 0 || duration === "") duration += seconds + " detik";
            
            return duration.trim();
        }

        function setQuickSchedule(minutesFromNow) {
            const now = new Date();
            const startTime = new Date(now.getTime() + (minutesFromNow * 60000));
            const endTime = new Date(startTime.getTime() + (5 * 60000));
            
            // Set ke schedule 1
            document.getElementById('start-hour-1').value = startTime.getHours();
            document.getElementById('start-minute-1').value = startTime.getMinutes();
            document.getElementById('start-second-1').value = startTime.getSeconds();
            document.getElementById('end-hour-1').value = endTime.getHours();
            document.getElementById('end-minute-1').value = endTime.getMinutes();
            document.getElementById('end-second-1').value = endTime.getSeconds();
            
            showNotification(`‚è±Ô∏è Jadwal diatur ${minutesFromNow} menit dari sekarang`, "info");
        }

        function setTestScheduleNow() {
            const now = new Date();
            const endTime = new Date(now.getTime() + (5 * 60000));
            
            document.getElementById('start-hour-1').value = now.getHours();
            document.getElementById('start-minute-1').value = now.getMinutes();
            document.getElementById('start-second-1').value = now.getSeconds();
            document.getElementById('end-hour-1').value = endTime.getHours();
            document.getElementById('end-minute-1').value = endTime.getMinutes();
            document.getElementById('end-second-1').value = endTime.getSeconds();
            
            showNotification("üöÄ Jadwal diatur mulai sekarang (5 menit)", "info");
        }

        function testSchedule(scheduleNumber) {
            const startHour = parseInt(document.getElementById(`start-hour-${scheduleNumber}`).value) || 0;
            const startMinute = parseInt(document.getElementById(`start-minute-${scheduleNumber}`).value) || 0;
            const startSecond = parseInt(document.getElementById(`start-second-${scheduleNumber}`).value) || 0;
            
            const startTime = formatTime(startHour, startMinute, startSecond);
            showNotification(`üß™ Testing Jadwal ${scheduleNumber}: ${startTime}`, "info");
        }

        function triggerScheduleNow() {
            if (!isPompaDeviceOnline) {
                showNotification("‚ùå Device pompa offline", "error");
                return;
            }
            
            fetch("/api/pompa/control", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    action: "on",
                    mode: "auto",
                    deviceId: deviceId,
                    source: "manual_trigger",
                    duration: 300
                }),
            })
            .then(response => response.json())
            .then(data => {
                showNotification("üöÄ Trigger manual (5 menit) dikirim", "success");
                addToHistoryFromData({
                    status: true,
                    mode: "auto",
                    deviceId: deviceId,
                    action: "manual_trigger"
                }, "web-dashboard");
            })
            .catch(error => {
                showNotification("‚ùå Gagal trigger manual", "error");
                console.error("Error:", error);
            });
        }

        function stopScheduleNow() {
            if (!isPompaDeviceOnline) {
                showNotification("‚ùå Device pompa offline", "error");
                return;
            }
            
            fetch("/api/pompa/control", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    action: "off",
                    mode: "auto",
                    deviceId: deviceId,
                    source: "manual_stop"
                }),
            })
            .then(response => response.json())
            .then(data => {
                showNotification("‚èπÔ∏è Stop manual dikirim", "success");
                addToHistoryFromData({
                    status: false,
                    mode: "auto",
                    deviceId: deviceId,
                    action: "manual_stop"
                }, "web-dashboard");
            })
            .catch(error => {
                showNotification("‚ùå Gagal stop manual", "error");
                console.error("Error:", error);
            });
        }

        function updateServerTime() {
            const now = new Date();
            const serverTime = formatTime(now.getHours(), now.getMinutes(), now.getSeconds());
            document.getElementById('server-time').textContent = serverTime;
        }

        // ==================== FUNGSI HISTORY ====================
        function addToHistoryFromData(data, controlledBy) {
            if (!data || data.status === undefined) return;
            
            const historyEntry = {
                timestamp: new Date().toLocaleTimeString(),
                status: data.status,
                mode: data.mode || "manual",
                controlled_by: controlledBy || "system",
                source: controlledBy === "web-dashboard" ? "Dashboard" : "ESP32",
                deviceId: data.deviceId || "POMPA_DEVICE",
                action: data.action || "control"
            };
            
            const lastEntry = historyLog[0];
            const now = Date.now();
            const isDuplicate = lastEntry && 
                lastEntry.status === historyEntry.status && 
                lastEntry.mode === historyEntry.mode &&
                (now - lastEntry._timestamp) < 5000;
            
            if (!isDuplicate) {
                historyEntry._timestamp = now;
                historyLog.unshift(historyEntry);
                
                if (historyLog.length > MAX_HISTORY_ITEMS) {
                    historyLog = historyLog.slice(0, MAX_HISTORY_ITEMS);
                }
                
                saveHistoryToStorage();
                updateTable(historyLog);
            }
        }

        function loadHistory() {
            try {
                const savedHistory = localStorage.getItem('pompaHistory');
                if (savedHistory) {
                    historyLog = JSON.parse(savedHistory) || [];
                    console.log("üìñ History loaded:", historyLog.length, "items");
                    updateTable(historyLog);
                } else {
                    updateTable([]);
                }
            } catch (error) {
                console.error("Error loading history:", error);
                updateTable([]);
            }
        }

        function saveHistoryToStorage() {
            try {
                localStorage.setItem('pompaHistory', JSON.stringify(historyLog));
            } catch (error) {
                console.error("Error saving history:", error);
            }
        }

        function updateTable(data) {
            const tbody = document.getElementById("tableBody");
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="history-empty">
                            üì≠ Belum ada riwayat kontrol pompa
                        </td>
                    </tr>
                `;
                return;
            }

            const displayData = data.slice(0, 10);
            tbody.innerHTML = "";

            displayData.forEach(item => {
                const status = item.status ? 
                    '<span style="color: #28a745; font-weight: bold;">üíß MENYALA</span>' : 
                    '<span style="color: #dc3545; font-weight: bold;">üî¥ MATI</span>';
                
                const mode = item.mode === "auto" ? 
                    '<span style="color: #17a2b8;">‚è∞ AUTO</span>' : 
                    '<span style="color: #6c757d;">üëã MANUAL</span>';
                
                const source = item.controlled_by === "web-dashboard" ? 
                    '<span style="color: #007bff;">üåê Dashboard</span>' : 
                    '<span style="color: #28a745;">ü§ñ ESP32</span>';
                
                const controlledBy = item.controlled_by === "web-dashboard" ? "Web Dashboard" : "System";

                tbody.innerHTML += `
                    <tr>
                        <td>${item.timestamp || "N/A"}</td>
                        <td>${status}</td>
                        <td>${mode}</td>
                        <td>${controlledBy}</td>
                        <td>${source}</td>
                    </tr>
                `;
            });
        }

        function showNotification(message, type) {
            const notification = document.createElement("div");
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;

            if (type === "success") notification.style.background = "#28a745";
            else if (type === "error") notification.style.background = "#dc3545";
            else if (type === "info") notification.style.background = "#17a2b8";
            else notification.style.background = "#6c757d";

            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 3000);
        }

        // ==================== INISIALISASI ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners untuk input waktu
            for (let i = 1; i <= 2; i++) {
                ['hour', 'minute', 'second'].forEach(type => {
                    const startInput = document.getElementById(`start-${type}-${i}`);
                    const endInput = document.getElementById(`end-${type}-${i}`);
                    
                    if (startInput) {
                        startInput.addEventListener('input', function() {
                            const value = parseInt(this.value);
                            const max = type === 'hour' ? 23 : 59;
                            if (isNaN(value) || value < 0) this.value = 0;
                            if (value > max) this.value = max;
                        });
                    }
                    
                    if (endInput) {
                        endInput.addEventListener('input', function() {
                            const value = parseInt(this.value);
                            const max = type === 'hour' ? 23 : 59;
                            if (isNaN(value) || value < 0) this.value = 0;
                            if (value > max) this.value = max;
                        });
                    }
                });
            }
            
            // Load data awal
            setTimeout(loadSchedulesFromServer, 1000);
            setInterval(updateServerTime, 1000);
            updateServerTime();
            
            // Start auto refresh
            loadData();
            setInterval(loadData, 3000);
            setInterval(checkConnectionTimeout, 5000);
        });

        // Debug function
        window.debugPompa = function() {
            console.log("üîß Debug Pompa Status:");
            console.log("- Device Online:", isPompaDeviceOnline);
            console.log("- Current Status:", currentPompaStatus);
            console.log("- Auto Mode:", isAutoMode);
            console.log("- Last Data:", lastPompaData);
            console.log("- Schedules:", currentSchedules);
            console.log("- Device ID:", deviceId);
            loadData();
            loadSchedulesFromServer();
        };
    </script>
</body>
</html>
